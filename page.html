<!doctype html>
<html>
<head>
<title>To Do List</title>
<meta name="description" content="TCS intro To Do List">
<meta name="keywords" content="html To Do List">
<style>
    #title-div {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        text-align: center;
    }

    #input-div {
        display: flex;
        flex-direction: row;
        width: 10%;
        margin: 0 auto;
    }

    #task-list {
        width: 15%;
        margin: 0 auto;
    }

    .item-container {
        display: flex;
        margin-bottom: 5px;
    }

    .list-text {
        width: 250px;
        max-width: 250px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .list-text[complete]{
        text-decoration: line-through;
    }

    .remove-button{
        margin-left: 5px;
        margin-right: 5px;
    }
</style>
</head>
<body>
    <div id="content-div">
        <div id="title-div">
            <h1>A really cool list that looks amazing</h1>
            <h2>Click an item to cross it off.<br>Click X to clear the item entirely</h2>
            <div id="input-div">
                <input onkeypress="checkAdd(event)" id="task"/>
                <button id="create-task" onclick="addTask()">Add</button>
            </div>
        </div>
        <ul id="task-list"></ul>
    </div>
</body>
<script>
    let currList;

    function addExistingTask(todo) {
        let list = document.getElementById("task-list");
        let item = document.createElement("div");
        let text = document.createElement("div");
        let button = document.createElement("button");

        text.className = "list-text";
        text.innerText = todo.name;
        if (todo.complete) {
            text.setAttribute("complete", "true");
        }

        button.innerText = "X";
        button.className = "remove-button";
        button.onclick = function(event) {
            event.stopPropagation();
            
            button.parentElement.remove();
            fetch('http://localhost:8888/todoList/remove', {
                'method': 'DELETE',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(todo)
            })
            .catch(err => {
                console.log(err);
            });
        }

        item.className = "item-container";
        item.onclick = function() {
            if (text.getAttribute("complete") == undefined) {
                text.setAttribute("complete", "true");
                todo.complete = true;
            } else {
                text.removeAttribute("complete");
                todo.complete = false;
            }

            fetch('http://localhost:8888/todoList/update', {
                'method': 'PUT',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(todo)
            })
            .catch(err => {
                console.log(err);
            });
        }

        item.appendChild(text);
        item.appendChild(button);
        list.appendChild(item);
    }

    function addTask() {
        let list = document.getElementById("task-list");
        let input = document.getElementById("task");
        let item = document.createElement("div");
        let text = document.createElement("div");
        let button = document.createElement("button");
        
        if (input.value.trim() == "") {
            input.value = "";
            input.focus();
            alert("Input cannot be empty");

            return;
        }

        for (todo of currList) {
            if (todo.name == input.value.trim()) {
                input.value = "";
                input.focus();
                alert("Cannot input a duplicate entry");

                return;
            }
        }

        fetch('http://localhost:8888/todoList/insert', {
            'method': 'PUT',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify({name: input.value.trim()})
        })
        .then(res => {
            if (res.status == 200) {
                let newTodo = {
                    name: input.value.trim(),
                    complete: false
                };
                currList.push(newTodo);

                text.className = "list-text";
                text.innerText = input.value.trim();

                button.innerText = "X";
                button.className = "remove-button";
                button.onclick = function(event) {
                    event.stopPropagation();

                    button.parentElement.remove();
                    fetch('http://localhost:8888/todoList/remove', {
                        'method': 'DELETE',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8'
                        },
                        body: JSON.stringify(newTodo)
                    })
                    .catch(err => {
                        console.log(err);
                    });
                }

                item.className = "item-container";
                item.onclick = function() {
                    if (text.getAttribute("complete") == undefined) {
                        text.setAttribute("complete", "true");
                        newTodo.complete = true;
                    } else {
                        text.removeAttribute("complete");
                        newTodo.complete = false;
                    }

                    fetch('http://localhost:8888/todoList/update', {
                        'method': 'PUT',
                        headers: {
                            'Content-Type': 'application/json;charset=utf-8'
                        },
                        body: JSON.stringify(newTodo)
                    })
                    .catch(err => {
                        console.log(err);
                    });
                }

                item.appendChild(text);
                item.appendChild(button);
                input.value = "";
                list.appendChild(item);
                input.focus();
            } else {
                input.value = "";
                input.focus();
                alert("Cannot input a duplicate entry");
            }
        })
        .catch(err => {
            input.value = "";
            input.focus();
        });
    }

    function checkAdd(event) {
        if (event.keyCode == 13) addTask();
    }

    function getAllTasks() {
        fetch("http://localhost:8888/todoList/getList")
        .then(res => res.json())
        .then(arr => {
            currList = arr;
            for (todo of currList) {
                addExistingTask(todo);
            }
        })
        .catch(err => {
            console.log(err);
        });
    }

    getAllTasks();
</script>
</html>